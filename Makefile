# ============================================================================================
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# ============================================================================================

# –û—Å–Ω–æ–≤–Ω—ã–µ Compose —Ñ–∞–π–ª—ã
COMPOSE_FILE = docker-compose.yaml
COMPOSE_FILE_PROD = docker-compose.prod.yaml
COMPOSE_FILE_TEST = docker-compose.test.yaml

# –ù–∞–∑–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –≤ compose)
BACKEND = backend

# ============================================================================================
# üöÄ –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
# ============================================================================================

## –ü–æ–¥–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏
up:
	docker compose -f $(COMPOSE_FILE) up

## –ü–æ–¥–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
up-build:
	docker compose -f $(COMPOSE_FILE) up --build

## –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è volumes)
down:
	docker compose -f $(COMPOSE_FILE) down

## –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —É–¥–∞–ª—è–µ—Ç volumes
down-with-volumes:
	docker compose -f $(COMPOSE_FILE) down -v

## –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å—ë –æ–∫—Ä—É–∂–µ–Ω–∏–µ
restart: down up-build

## –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ backend-—Å–µ—Ä–≤–∏—Å–∞
logs:
	docker compose -f $(COMPOSE_FILE) logs -f $(BACKEND)

# ============================================================================================
# üèóÔ∏è Production
# ============================================================================================

## –ó–∞–ø—É—Å–∫ production-–æ–∫—Ä—É–∂–µ–Ω–∏—è
up-build-prod:
	docker compose -f $(COMPOSE_FILE) -f $(COMPOSE_FILE_PROD) up -d --build

# ============================================================================================
# üß© –ú–∏–≥—Ä–∞—Ü–∏–∏ (Alembic)
# ============================================================================================

m ?= Auto migration

## –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
migrate:
	docker compose -f $(COMPOSE_FILE) exec $(BACKEND) alembic upgrade head

## –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
makemigrations:
	docker compose -f $(COMPOSE_FILE) exec $(BACKEND) alembic revision --autogenerate -m "$(m)"

# ============================================================================================
# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================================================

## –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ —É–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
test-backend:
	docker compose -f $(COMPOSE_FILE) -f $(COMPOSE_FILE_TEST) up --build --abort-on-container-exit
	docker compose -f $(COMPOSE_FILE) -f $(COMPOSE_FILE_TEST) down

# ============================================================================================
# üßπ –£—Ç–∏–ª–∏—Ç—ã
# ============================================================================================

## –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
ps:
	docker compose ps


include_volumes ?= false
## –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (include_volumes=false –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
clean:
	docker system prune -f $(if $(filter true 1,$(include_volumes)),--volumes)

## –í—ã–≤–æ–¥ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ
help:
	@awk '\
		/^[[:space:]]*##[[:space:]]*/ { desc = substr($$0, match($$0, /##[[:space:]]*/)+RLENGTH); next } \
		/^[[:space:]]*$$/ { next } \
		/^[a-zA-Z0-9_.-]+[[:space:]]*:/ { \
			split($$0, a, ":"); \
			target = a[1]; \
			sub(/^[[:space:]]+/, "", desc); \
			sub(/[[:space:]]+$$/, "", desc); \
			printf "\033[92m%-20s\033[0m %s\n", target, desc; \
			desc = ""; \
		} \
	' $(MAKEFILE_LIST)


